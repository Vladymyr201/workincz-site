# Руководство по GitHub Actions для проекта WorkInCZ

Данное руководство описывает все настройки и workflow GitHub Actions, используемые в проекте WorkInCZ.

## Общая структура GitHub Actions

В проекте используются различные GitHub Actions workflow для автоматизации следующих процессов:

1. **CI/CD процессы**
   - Сборка и тестирование кода (CI)
   - Деплой на Firebase Hosting и Functions
   - Деплой на GitHub Pages

2. **Резервное копирование**
   - Ежедневное резервное копирование данных Firestore

3. **Безопасность**
   - Проверка безопасности кода
   - Сканирование зависимостей

4. **Автоматизация рутинных операций**
   - Автоматические коммиты для обновления документации
   - Генерация случайных цитат для сайта

## Основные workflow файлы

### CI/CD

| Файл | Описание | Триггеры |
|------|----------|----------|
| `ci.yml` | Базовая проверка сборки и тестов | Push, Pull Request |
| `ci-cd-pipeline.yml` | Полный цикл CI/CD с деплоем | Push в main/develop, Pull Request в main |
| `firebase-deploy.yml` | Деплой на Firebase Hosting и Functions | Push в main, ручной запуск |
| `deploy.yml` | Деплой на GitHub Pages | Push в main/master, Pull Request |

### Резервное копирование

| Файл | Описание | Триггеры |
|------|----------|----------|
| `firestore-backup.yml` | Резервное копирование Firestore | Расписание (каждый день), ручной запуск |

### Безопасность

| Файл | Описание | Триггеры |
|------|----------|----------|
| `security-scan.yml` | Сканирование кода на уязвимости | Push в main, расписание |
| `security-check.yml` | Проверка зависимостей | Расписание, ручной запуск |

### Дополнительные workflow

| Файл | Описание | Триггеры |
|------|----------|----------|
| `auto-commit.yml` | Автоматическое создание коммитов для обновления документации | Расписание |
| `random_quote.yml` | Генерация случайных цитат | Расписание |
| `mcp-automation.yml` | Автоматизация операций MCP | Разные события |

## Необходимые секреты

Для корректной работы GitHub Actions требуются следующие секреты:

| Секрет | Описание | Используется в |
|--------|----------|--------------|
| `FIREBASE_TOKEN` | Токен Firebase для деплоя | firebase-deploy.yml, ci-cd-pipeline.yml |
| `GCP_PROJECT_ID` | ID проекта Google Cloud | firestore-backup.yml |
| `GCP_SA_KEY` | Ключ сервисного аккаунта Google Cloud | firestore-backup.yml |
| `GCP_SA_EMAIL` | Email сервисного аккаунта | firestore-backup.yml |
| `GCS_BUCKET` | Имя бакета Google Cloud Storage | firestore-backup.yml |
| `SLACK_WEBHOOK_URL` | URL для уведомлений в Slack | firestore-backup.yml |

Подробную информацию о настройке секретов можно найти в файле [GITHUB_SECRETS_SETUP.md](./GITHUB_SECRETS_SETUP.md).

## Структура репозитория GitHub

```
.github/
  ├── workflows/           # GitHub Actions workflow файлы
  ├── ISSUE_TEMPLATE/      # Шаблоны для создания задач
  ├── CODEOWNERS          # Назначение владельцев кода для ревью
  ├── dependabot.yml      # Настройки автоматического обновления зависимостей
  └── pull_request_template.md # Шаблон для создания Pull Request
```

## Рекомендации по работе с GitHub Actions

### Разработка и тестирование workflow

1. Используйте флаг `workflow_dispatch` для возможности ручного запуска
2. Добавляйте условия `if` для предотвращения ненужных выполнений шагов
3. Используйте кэширование для ускорения сборок

### Безопасность

1. Используйте конкретные версии actions (например, `actions/checkout@v3`)
2. Не храните секреты в коде, используйте GitHub Secrets
3. Ограничивайте права сервисных аккаунтов

### Оптимизация

1. Разделяйте задачи на отдельные jobs для параллельного выполнения
2. Используйте матрицы для тестирования в различных окружениях
3. Кэшируйте зависимости и артефакты сборки

## Автоматическое обновление зависимостей (Dependabot)

В проекте настроен Dependabot для автоматического обновления:
- npm-пакетов (еженедельно)
- GitHub Actions (ежемесячно)

Настройки находятся в файле `.github/dependabot.yml`.

## Проверка настройки GitHub

Для проверки правильности настройки GitHub Actions можно использовать скрипт:

```bash
node scripts/check-github-secrets.js
```

## Часто возникающие проблемы и их решения

### Ошибки при деплое на Firebase

**Проблема**: Ошибка доступа при деплое на Firebase.
**Решение**: Обновите токен Firebase с помощью команды `firebase login:ci` и обновите секрет `FIREBASE_TOKEN`.

### Ошибки при резервном копировании Firestore

**Проблема**: Недостаточно прав для создания резервной копии.
**Решение**: Убедитесь, что сервисный аккаунт имеет роли `datastore.importExportAdmin` и `storage.objectAdmin`.

### Ошибки "Context access might be invalid"

**Проблема**: Предупреждения линтера в workflow файлах.
**Решение**: Используйте `env` контекст для передачи переменных между шагами.