# Настройка автоматического резервного копирования Firestore

В этом документе описано, как настроить автоматическое резервное копирование базы данных Firestore с помощью GitHub Actions.

## Особенности системы резервного копирования

- ✅ **Ежедневные автоматические бэкапы** - создаются в 03:00 UTC каждый день
- ✅ **Защита данных** - опциональное шифрование бэкапов с использованием AES-256
- ✅ **Управление жизненным циклом** - автоматическое удаление бэкапов старше заданного периода (по умолчанию 14 дней)
- ✅ **Мониторинг срока действия ключей** - предупреждения, когда ключи сервисного аккаунта скоро истекут
- ✅ **Уведомления** - интеграция со Slack для мгновенных уведомлений об успехе или ошибках
- ✅ **Ручной запуск** - возможность запустить процесс резервного копирования вручную в любой момент

## Требования

1. Сервисный аккаунт Google Cloud с разрешениями:
   - `roles/datastore.importExportAdmin` - для экспорта данных Firestore
   - `roles/storage.objectAdmin` - для записи резервных копий в бакет

2. Бакет Google Cloud Storage для хранения резервных копий

## Настройка секретов в GitHub

Для работы workflow необходимо добавить следующие секреты в настройках репозитория:

| Секрет | Описание | Обязательный |
|--------|----------|-------------|
| `GCP_PROJECT_ID` | ID проекта Google Cloud | Да |
| `GCP_SA_KEY` | Ключ сервисного аккаунта Google Cloud в формате JSON (base64-закодированный) | Да |
| `GCP_SA_EMAIL` | Email сервисного аккаунта для проверки ключей | Да |
| `GCS_BUCKET` | Имя бакета Google Cloud Storage для хранения резервных копий | Да |
| `SLACK_WEBHOOK_URL` | URL вебхука Slack для уведомлений | Нет |
| `BACKUP_ENCRYPTION_KEY` | Секретный ключ для шифрования бэкапов | Нет |

### Как создать и закодировать ключ сервисного аккаунта

1. Создайте сервисный аккаунт в консоли Google Cloud
2. Сгенерируйте ключ в формате JSON
3. Закодируйте ключ в base64:

```bash
cat path_to_key.json | base64 -w 0
```

4. Скопируйте результат и добавьте его как секрет `GCP_SA_KEY`

## Настройка параметров хранения

По умолчанию бэкапы хранятся 14 дней. Чтобы изменить этот период, отредактируйте параметр `RETENTION_DAYS` в файле `.github/workflows/firestore-backup.yml`.

## Ручной запуск резервного копирования

Для ручного запуска резервного копирования:

1. Перейдите в раздел "Actions" вашего репозитория
2. Выберите workflow "Firestore Backup"
3. Нажмите "Run workflow"
4. Нажмите зеленую кнопку "Run workflow"

## Проверка и восстановление резервных копий

### Проверка существующих бэкапов

```bash
gsutil ls gs://YOUR_BUCKET_NAME/backup-*
```

### Импорт данных из резервной копии

```bash
gcloud firestore import gs://YOUR_BUCKET_NAME/backup-YYYY-MM-DD-HHMMSS
```

> ⚠️ **Предупреждение**: Операция импорта в существующую базу данных может привести к объединению или перезаписи данных. Перед выполнением этой операции в производственной среде рекомендуется протестировать процесс восстановления в тестовой среде.

## Устранение неполадок

### Ошибка аутентификации

Проверьте правильность секрета `GCP_SA_KEY` и наличие всех необходимых разрешений у сервисного аккаунта.

### Ошибка доступа к бакету

Убедитесь, что сервисный аккаунт имеет разрешение `storage.objectAdmin` для указанного бакета.

### Ошибка при проверке срока действия ключей

Убедитесь, что секрет `GCP_SA_EMAIL` содержит правильный адрес электронной почты сервисного аккаунта.

## Дополнительные настройки

### Изменение расписания

По умолчанию бэкап выполняется каждый день в 03:00 UTC. Чтобы изменить расписание, отредактируйте параметр `cron` в файле `.github/workflows/firestore-backup.yml`.

### Расширенные уведомления

Для интеграции с другими сервисами уведомлений (например, Microsoft Teams, Discord, Email), отредактируйте шаги `Notify on success` и `Notify on failure` в файле workflow.