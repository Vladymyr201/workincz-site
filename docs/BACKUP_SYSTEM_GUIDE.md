# Руководство по системе резервного копирования WorkInCZ

В этом документе представлено полное руководство по настройке, поддержке и восстановлению из резервных копий для платформы WorkInCZ.

## Общая архитектура системы резервного копирования

![Архитектура системы резервного копирования](https://via.placeholder.com/800x400?text=Архитектура+системы+резервного+копирования)

Система резервного копирования WorkInCZ включает следующие компоненты:

1. **GitHub Actions Workflows** - Автоматическое создание резервных копий по расписанию
2. **Google Cloud Storage** - Хранение зашифрованных и незашифрованных бэкапов
3. **Система мониторинга** - Отслеживание успешных и неудачных операций резервного копирования
4. **Система уведомлений** - Оповещение команды о состоянии резервных копий
5. **Скрипты восстановления** - Инструменты для восстановления данных из бэкапов

## Компоненты системы резервного копирования

### Firestore Backup

Ежедневные автоматические резервные копии базы данных Firestore выполняются с помощью GitHub Action (`firestore-backup.yml`).

#### Основные возможности:

- ✅ **Ежедневные бэкапы в 03:00 UTC**
- ✅ **Шифрование чувствительных данных с AES-256**
- ✅ **Автоматическое удаление старых бэкапов (старше 14 дней)**
- ✅ **Проверка срока действия ключей сервисного аккаунта**
- ✅ **Интеграция со Slack для оповещений**
- ✅ **Возможность запуска вручную через GitHub Actions**

### Firebase Storage Backup

В разработке.

### Realtime Database Backup

В разработке.

## Настройка системы резервного копирования

### Необходимые секреты

Для работы системы резервного копирования требуются следующие секреты GitHub:

| Секрет | Описание | Обязательный |
|--------|----------|-------------|
| `GCP_PROJECT_ID` | ID проекта Google Cloud | Да |
| `GCP_SA_KEY` | Ключ сервисного аккаунта Google Cloud (base64) | Да |
| `GCP_SA_EMAIL` | Email сервисного аккаунта | Да |
| `GCS_BUCKET` | Имя бакета Google Cloud Storage | Да |
| `SLACK_WEBHOOK_URL` | URL для отправки уведомлений в Slack | Нет |
| `BACKUP_ENCRYPTION_KEY` | Ключ шифрования бэкапов | Нет |

### Настройка сервисного аккаунта Google Cloud

1. Создайте сервисный аккаунт в консоли Google Cloud:
   ```
   https://console.cloud.google.com/iam-admin/serviceaccounts
   ```

2. Предоставьте следующие роли:
   - `roles/datastore.importExportAdmin` - для экспорта Firestore
   - `roles/storage.objectAdmin` - для управления объектами в бакете

3. Создайте ключ для сервисного аккаунта в формате JSON

4. Закодируйте ключ в base64:
   ```bash
   cat path_to_key.json | base64 -w 0
   ```

5. Добавьте закодированный ключ как секрет `GCP_SA_KEY` в репозитории GitHub

### Создание бакета Google Cloud Storage

1. Создайте бакет в консоли Google Cloud Storage:
   ```
   https://console.cloud.google.com/storage/browser
   ```

2. Рекомендуемые настройки:
   - **Класс хранилища**: Standard
   - **Расположение**: EU (multi-region) для соответствия требованиям GDPR
   - **Управление доступом**: Fine-grained
   - **Защита данных**: Включите версионирование объектов
   - **Шифрование**: Google-managed key (по умолчанию)

3. Добавьте имя бакета как секрет `GCS_BUCKET` в репозитории GitHub

### Настройка уведомлений Slack

1. Создайте Incoming Webhook в Slack:
   ```
   https://api.slack.com/apps → Create New App → Incoming Webhooks
   ```

2. Добавьте URL вебхука как секрет `SLACK_WEBHOOK_URL` в репозитории GitHub

### Проверка настройки

Для проверки правильности настройки системы резервного копирования выполните скрипт:

```bash
node scripts/check-github-secrets.js
```

## Мониторинг и обслуживание

### Мониторинг статуса бэкапов

1. Проверяйте статус выполнения workflow в GitHub Actions:
   ```
   https://github.com/[your-username]/workincz-site/actions/workflows/firestore-backup.yml
   ```

2. Настройте оповещения в Slack для автоматического мониторинга

### Периодическое тестирование восстановления

Рекомендуется периодически (раз в квартал) проверять возможность восстановления из резервной копии:

1. Создайте тестовую среду Firebase
2. Восстановите бэкап в тестовую среду
3. Проверьте целостность и доступность данных

## Процедуры восстановления

### Восстановление Firestore из резервной копии

1. Найдите нужную резервную копию:
   ```bash
   gsutil ls gs://[YOUR_BUCKET]/backup-*
   ```

2. Восстановите данные в Firestore:
   ```bash
   gcloud firestore import gs://[YOUR_BUCKET]/backup-YYYY-MM-DD-HHMMSS
   ```

### Расшифровка зашифрованных бэкапов

Если бэкап был зашифрован (имеет расширение `.enc`):

1. Скачайте зашифрованный файл:
   ```bash
   gsutil cp gs://[YOUR_BUCKET]/backup-YYYY-MM-DD-HHMMSS.enc /tmp/
   ```

2. Расшифруйте файл:
   ```bash
   openssl enc -d -aes-256-cbc -pbkdf2 -in /tmp/backup-YYYY-MM-DD-HHMMSS.enc -out /tmp/backup-YYYY-MM-DD-HHMMSS.tar.gz -k "[YOUR_ENCRYPTION_KEY]"
   ```

3. Распакуйте архив:
   ```bash
   tar -xzf /tmp/backup-YYYY-MM-DD-HHMMSS.tar.gz -C /tmp
   ```

## План действий при катастрофах (DRP)

### Сценарии восстановления

#### 1. Повреждение данных Firestore

1. Заблокируйте доступ к приложению (переключите на страницу обслуживания)
2. Определите последнюю корректную резервную копию
3. Восстановите данные из резервной копии
4. Проверьте целостность данных
5. Восстановите доступ к приложению

#### 2. Удаление проекта Firebase

1. Создайте новый проект Firebase с тем же ID (если возможно)
2. Настройте сервисы Firebase (Auth, Firestore и т.д.)
3. Восстановите данные из последней резервной копии
4. Обновите конфигурацию в коде (если изменился ID проекта)
5. Тестирование и верификация

#### 3. Компрометация учетных данных

1. Отзовите все скомпрометированные ключи и токены
2. Создайте новые ключи сервисных аккаунтов
3. Обновите секреты в GitHub Actions
4. Проверьте журналы доступа на наличие несанкционированного доступа
5. Запустите ручное резервное копирование для проверки новой конфигурации

## Контакты и ответственность

| Имя | Роль | Контактная информация | Ответственность |
|-----|------|----------------------|----------------|
| [Имя 1] | DevOps инженер | [email] | Настройка и мониторинг системы резервного копирования |
| [Имя 2] | Архитектор данных | [email] | Проверка целостности данных, схемы восстановления |
| [Имя 3] | Администратор Firebase | [email] | Доступ и настройка Firebase, восстановление |

## Проверка и аудит системы

Регулярный аудит системы резервного копирования должен выполняться раз в полгода:

1. Проверка успешности и регулярности создания бэкапов
2. Тестовое восстановление в изолированной среде
3. Проверка прав доступа и политик безопасности
4. Обновление документации и контактов
5. Обзор и оптимизация стратегии резервного копирования

## Обучение команды

Каждый новый член команды должен быть ознакомлен с системой резервного копирования:

1. Расположение и структура бэкапов
2. Процедуры восстановления
3. Процесс создания и проверки бэкапов
4. Система мониторинга и уведомлений

## Соответствие нормативным требованиям

### GDPR

- Данные хранятся в ЕС (мультирегион EU)
- Бэкапы шифруются для защиты персональных данных
- Установлен период хранения бэкапов (14 дней)
- Доступ к бэкапам строго контролируется

### Отраслевые стандарты

- ISO 27001 (Информационная безопасность)
- NIST (Национальный институт стандартов и технологий)

## История изменений системы резервного копирования

| Дата | Версия | Описание изменений | Автор |
|------|--------|-------------------|-------|
| YYYY-MM-DD | 1.0 | Первоначальная настройка системы Firestore бэкапов | [Имя автора] |
| YYYY-MM-DD | 1.1 | Добавление шифрования бэкапов | [Имя автора] |