# Система обработки ошибок в GitHub Actions workflows

Этот документ описывает улучшенную систему обработки ошибок для GitHub Actions workflows в репозитории.

## Обзор

Система обработки ошибок предоставляет единый набор инструментов для:

1. Единообразного логирования и форматирования ошибок
2. Проверки доступа к ресурсам Google Cloud Platform
3. Проверки наличия необходимых секретов
4. Отправки информативных уведомлений в Slack
5. Сбора диагностической информации при сбоях

## Компоненты системы

### 1. Утилиты обработки ошибок

Файл: `.github/actions/workflow-utils/error-handlers.sh`

Содержит набор Bash-функций для работы с ошибками:

- `log_error` - форматированное логирование ошибок
- `check_gcp_access` - проверка доступа к ресурсам GCP
- `check_required_secrets` - проверка наличия необходимых секретов
- `send_slack_notification` - отправка детализированных уведомлений в Slack

### 2. Сохранение диагностических логов

Каждый workflow сохраняет диагностическую информацию в папку `.github/logs/[workflow-name]/`:

- Версии используемых инструментов
- Статус выполнения
- Информация о среде выполнения
- Дополнительные детали для отладки

## Использование в workflows

### Подключение утилит

```yaml
- name: Your step name
  run: |
    # Загружаем функции обработки ошибок
    source .github/actions/workflow-utils/error-handlers.sh || {
      echo "::error::Не удалось загрузить утилиты обработки ошибок"
      exit 1
    }
    
    # Теперь можно использовать функции
    check_required_secrets "SECRET_NAME1" "SECRET_NAME2"
```

### Проверка доступа к ресурсам GCP

```yaml
# Проверка доступа к бакету
check_gcp_access "bucket" "${{ secrets.GCS_BUCKET }}" || exit 1

# Проверка доступа к проекту
check_gcp_access "project" "${{ secrets.GCP_PROJECT_ID }}" || exit 1

# Проверка доступа к Firestore
check_gcp_access "firestore" "${{ secrets.GCP_PROJECT_ID }}" || exit 1
```

### Проверка наличия секретов

```yaml
# Проверяем наличие необходимых секретов
check_required_secrets "GCP_PROJECT_ID" "GCP_SA_KEY" "GCS_BUCKET" || exit 1
```

### Отправка уведомлений в Slack

```yaml
# Уведомление об успешном выполнении
send_slack_notification "$WEBHOOK_URL" "success" "Заголовок" "Текст сообщения" "Дополнительные детали"

# Уведомление об ошибке
send_slack_notification "$WEBHOOK_URL" "failure" "Заголовок" "Текст сообщения" "Дополнительные детали"
```

## Сохранение диагностической информации

Для добавления сохранения диагностической информации в workflow, добавьте следующий шаг:

```yaml
- name: Save diagnostics information
  if: always()
  run: |
    # Загружаем функции обработки ошибок
    source .github/actions/workflow-utils/error-handlers.sh || true
    
    # Сохраняем информацию о выполнении
    DIAGNOSTICS_FILE="${{ env.ERROR_LOGS_PATH }}/diagnostics-$(date +%Y%m%d-%H%M%S).log"
    
    {
      echo "========== Диагностика выполнения =========="
      echo "Дата/Время: $(date)"
      echo "Статус: ${{ job.status }}"
      # Другая полезная информация...
    } > "$DIAGNOSTICS_FILE"
```

## Рекомендации по обработке ошибок

1. **Всегда используйте единый стиль логирования ошибок** через `log_error`.
2. **Проверяйте наличие секретов** в начале выполнения workflow.
3. **Проверяйте доступ к внешним ресурсам** перед их использованием.
4. **Предоставляйте подробную диагностическую информацию** при возникновении ошибок.
5. **Используйте `continue-on-error: true`** для некритичных шагов.
6. **Сохраняйте логи даже при сбоях** с помощью `if: always()`.

## Известные ограничения

1. Утилиты работают только в Unix-подобных средах (GitHub Actions использует Ubuntu).
2. Функции не работают в PowerShell шагах (используются Bash функции).
3. При использовании в Windows-окружении могут возникнуть проблемы с окончаниями строк.

## Планы по улучшению

1. Добавить поддержку других облачных провайдеров (AWS, Azure).
2. Реализовать систему централизованного хранения и анализа логов.
3. Добавить автоматическое создание issues при возникновении ошибок.