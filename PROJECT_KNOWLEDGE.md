# PROJECT_KNOWLEDGE - WorkInCZ

## Архитектура проекта

### Общая структура

Проект WorkInCZ представляет собой европейскую платформу для поиска работы с фокусом на трудоустройство мигрантов. Архитектура проекта находится в процессе миграции с традиционной HTML/CSS/JS на современный стек Next.js/React/TypeScript.

Текущая архитектура включает:
- **Frontend**: 
  - HTML/CSS/JS (устаревшая часть)
  - Next.js/React/TypeScript (новая часть)
  - Tailwind CSS для стилизации
  - Shadcn UI и Radix UI для компонентов интерфейса
- **Backend**: 
  - Firebase (Authentication, Firestore, Storage, Realtime Database)
  - Next.js API Routes
  - МПС (Model Context Protocol) серверы
- **Инфраструктура**: 
  - Firebase Hosting
  - Vercel (для Next.js)

### Структура директорий

- `/public` - Статические файлы для HTML/JS части
- `/src` - Исходный код Next.js/React/TypeScript части
  - `/app` - Next.js App Router
  - `/components` - React-компоненты
  - `/lib` - Утилиты и сервисы
  - `/hooks` - React-хуки
  - `/types` - TypeScript типы и интерфейсы
  - `/utils` - Вспомогательные функции
- `/docs` - Документация проекта
- `/servers` - МПС серверы и связанные компоненты

## Ключевые компоненты

### Firebase интеграция

Проект использует Firebase для различных сервисов:

1. **Firebase Authentication** - Аутентификация пользователей
2. **Firestore** - Хранение данных пользователей, вакансий и других объектов
3. **Firebase Storage** - Хранение файлов (резюме, аватары)
4. **Realtime Database** - Чаты и уведомления в реальном времени

Для обеспечения единой конфигурации Firebase реализованы:
- `src/lib/firebase.ts` - Конфигурация Firebase для Next.js части
- `public/js/firebase-config.js` - Конфигурация Firebase для HTML/JS части
- `public/js/firebase-init.js` - Инициализация Firebase для HTML/JS части

### Система аутентификации

Система аутентификации включает:

1. **AuthContext** (`src/lib/authContext.tsx`) - React Context для управления состоянием аутентификации
2. **useAuth** (`src/hooks/useAuth.ts`) - React-хук для работы с аутентификацией
3. **AuthService** (`src/lib/auth.ts`) - Сервис для работы с Firebase Authentication
4. **Middleware** (`src/middleware.ts`) - Next.js middleware для защиты маршрутов

Формы аутентификации реализованы с использованием React Hook Form и Zod для валидации:
- `src/components/auth/signin-form-rhf.tsx` - Форма входа
- `src/components/auth/signup-form-rhf.tsx` - Форма регистрации
- `src/components/auth/reset-password-form-rhf.tsx` - Форма сброса пароля
- `src/components/auth/auth-forms.tsx` - Контейнер для форм аутентификации

### МПС интеграция

Проект использует МПС (Model Context Protocol) серверы для расширения функциональности:

1. **МПС memory** - Хранение предпочтений пользователей
   - `src/lib/userPreferences.ts` - Хук для работы с предпочтениями
   - `src/app/api/preferences/[userId]/route.ts` - API для работы с предпочтениями

2. **МПС sequentialthinking** - Система рекомендаций вакансий
   - `src/lib/jobRecommendations.ts` - Хук для получения рекомендаций
   - `src/app/api/recommendations/route.ts` - API для получения рекомендаций
   - `src/components/jobs/job-recommendations.tsx` - Компонент для отображения рекомендаций

## Решенные проблемы

### Дублирование конфигурации Firebase

**Проблема**: Конфигурация Firebase была дублирована в разных частях проекта, что приводило к сложностям в поддержке и потенциальным ошибкам.

**Решение**: 
1. Создан единый файл конфигурации Firebase для HTML/JS части (`public/js/firebase-config.js`)
2. Создан единый файл конфигурации Firebase для Next.js части (`src/lib/firebase.ts`)
3. Реализована проверка инициализации Firebase для предотвращения повторной инициализации
4. Обновлены все импорты для использования единой конфигурации

### Фрагментированная система аутентификации

**Проблема**: Система аутентификации была разделена между HTML/JS и Next.js частями проекта, что приводило к дублированию кода и несогласованности.

**Решение**:
1. Создан единый контекст аутентификации с React Context API
2. Разработан хук useAuth для работы с аутентификацией
3. Оптимизирован middleware для защиты маршрутов
4. Добавлена расширенная система управления ролями
5. Разработаны унифицированные формы аутентификации с использованием React Hook Form

## Оптимизации

### Оптимизация загрузки Firebase SDK

Для оптимизации загрузки Firebase SDK реализованы:
1. Динамический импорт Firebase модулей
2. Отложенная инициализация Firebase Analytics
3. Предварительная загрузка основных модулей Firebase

### Оптимизация форм аутентификации

Для оптимизации форм аутентификации реализованы:
1. Валидация на стороне клиента с использованием Zod
2. Предотвращение повторной отправки форм
3. Асинхронная валидация полей
4. Оптимизированная обработка ошибок

### Оптимизация рендеринга

Для оптимизации рендеринга реализованы:
1. Использование React.memo для предотвращения лишних рендеров
2. Использование useCallback и useMemo для оптимизации функций и вычислений
3. Оптимизация условного рендеринга

## Паттерны кода

### React Context API

Используется для глобального состояния:
1. AuthContext - Состояние аутентификации
2. ThemeContext - Настройки темы оформления
3. NotificationContext - Управление уведомлениями

### React Hooks

Разработаны кастомные хуки для инкапсуляции логики:
1. useAuth - Работа с аутентификацией
2. useUserPreferences - Работа с предпочтениями пользователя
3. useJobRecommendations - Получение рекомендаций вакансий
4. useApplications - Работа с откликами на вакансии
5. useDashboard - Работа с данными дашборда

### Адаптеры

Используются для обеспечения совместимости между разными частями проекта:
1. firebase-integration.js - Адаптер для совместимости Firebase между HTML/JS и Next.js
2. api-adapter.ts - Адаптер для работы с разными версиями API

## Команды деплоя

### Деплой на Firebase Hosting

```bash
# Сборка проекта
npm run build

# Деплой на Firebase Hosting
firebase deploy --only hosting
```

### Деплой на Vercel

```bash
# Деплой на Vercel
vercel --prod
```

## Технические заметки

### Миграция на Next.js

Проект находится в процессе миграции с традиционной HTML/CSS/JS архитектуры на Next.js/React/TypeScript. Миграция выполняется постепенно, с сохранением работоспособности существующей функциональности.

### Интеграция МПС серверов

Для расширения функциональности проекта интегрированы МПС (Model Context Protocol) серверы:
1. МПС memory - Для хранения предпочтений пользователей
2. МПС sequentialthinking - Для системы рекомендаций вакансий

### Многоязычность

Проект поддерживает многоязычность с использованием:
1. Next.js i18n routing для маршрутизации
2. Локализованных JSON-файлов для переводов
3. Поддержки направления текста (LTR/RTL)

## Известные баги

1. **Проблема с кэшированием Firebase Auth**: В некоторых случаях состояние аутентификации может не обновляться корректно при переключении между HTML/JS и Next.js частями. Решение: явное обновление токена при переходе между частями.

2. **Несовместимость версий Firebase SDK**: Разные части проекта могут использовать разные версии Firebase SDK, что может приводить к ошибкам. Решение: унификация версий Firebase SDK.

## Успешные практики

1. **Единая конфигурация Firebase**: Централизованная конфигурация Firebase упрощает поддержку и предотвращает ошибки.

2. **React Context для глобального состояния**: Использование React Context API для управления глобальным состоянием упрощает разработку и поддержку.

3. **Кастомные хуки для инкапсуляции логики**: Разработка кастомных хуков позволяет инкапсулировать логику и упростить компоненты.

4. **Валидация форм с Zod**: Использование Zod для валидации форм обеспечивает типобезопасность и упрощает обработку ошибок.

5. **МПС для расширения функциональности**: Использование МПС серверов позволяет расширить функциональность проекта без усложнения основного кода.

### Система резервного копирования Firestore

Для обеспечения сохранности данных реализована система автоматического резервного копирования Firestore:

1. **GitHub Actions Workflow**: `.github/workflows/firestore-backup.yml` - ежедневное резервное копирование в 03:00 UTC
2. **Защита данных**: Опциональное шифрование бэкапов с использованием AES-256
3. **Ротация бэкапов**: Автоматическое удаление резервных копий старше 14 дней
4. **Мониторинг ключей**: Проверка срока действия ключей сервисного аккаунта Google Cloud
5. **Интеграция с системами уведомлений**: Отправка уведомлений об успешном создании бэкапа или ошибках в Slack

Подробная документация доступна в файле `docs/FIRESTORE_BACKUP_SETUP.md`.

### Система обработки ошибок в GitHub Actions workflows

Для повышения надежности и диагностируемости CI/CD процессов реализована централизованная система обработки ошибок в GitHub Actions:

1. **Утилиты обработки ошибок**: `.github/actions/workflow-utils/error-handlers.sh` - набор Bash-функций для стандартизированной обработки ошибок
2. **Улучшенная диагностика**: Автоматическое сохранение диагностической информации при сбоях
3. **Проверки окружения**: Стандартизированные проверки доступа к ресурсам GCP, наличия секретов и других зависимостей
4. **Информативные уведомления**: Расширенная система уведомлений с подробной информацией об ошибках
5. **Явное указание project_id**: Добавление параметра `--project=PROJECT_ID` во все команды `gcloud` и параметра `-u PROJECT_ID` во все команды `gsutil` для предотвращения ошибок аутентификации

Система обработки ошибок используется в следующих workflows:
- Firestore Backup (`.github/workflows/firestore-backup.yml`)
- Security Check (`.github/workflows/security-check.yml`)

Подробная документация доступна в файлах `docs/WORKFLOW_ERROR_HANDLING.md` и `docs/GITHUB_ACTIONS_SECRETS.md`.

## Дальнейшие планы

1. **Завершение миграции на Next.js**: Полный переход на Next.js/React/TypeScript архитектуру.

2. **Расширение системы рекомендаций**: Улучшение системы рекомендаций вакансий с использованием машинного обучения.

3. **Интеграция дополнительных методов аутентификации**: Добавление поддержки аутентификации через Apple, Facebook и другие провайдеры.

4. **Разработка мобильного приложения**: Создание мобильного приложения с использованием React Native.

5. **Улучшение системы уведомлений**: Разработка системы уведомлений в реальном времени с использованием WebSockets.

6. **Расширение системы резервного копирования**: Добавление резервного копирования Firebase Storage и других сервисов.

7. **Расширение системы обработки ошибок**: Добавление поддержки других облачных провайдеров и централизованной системы анализа логов.