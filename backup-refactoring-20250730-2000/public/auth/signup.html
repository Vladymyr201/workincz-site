<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Регистрация - WorkInCZ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#F59E0B',
                        success: '#10B981'
                    }
                }
            }
        }
    </script>
    <style>
        .button-ripple {
            position: relative;
            overflow: hidden;
        }
        .button-ripple::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .button-ripple:active::after {
            width: 300px;
            height: 300px;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
        <!-- Header -->
        <div class="text-center">
            <a href="/" class="flex items-center justify-center space-x-2 mb-8">
                <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center">
                    <i class="ri-briefcase-line text-white text-lg"></i>
                </div>
                <span class="text-xl font-bold text-gray-900">WorkInCZ</span>
            </a>
            <h2 class="text-3xl font-bold text-gray-900">Создать аккаунт</h2>
            <p class="mt-2 text-sm text-gray-600">
                Присоединяйтесь к тысячам соискателей работы в Чехии
            </p>
        </div>

        <!-- Progress Steps -->
        <div class="flex items-center justify-center space-x-4 mb-8">
            <div class="flex items-center">
                <div id="step-1-indicator" class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center text-sm font-medium">1</div>
                <span class="ml-2 text-sm font-medium text-primary">Аккаунт</span>
            </div>
            <div class="w-8 h-0.5 bg-gray-300"></div>
            <div class="flex items-center">
                <div id="step-2-indicator" class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-medium">2</div>
                <span class="ml-2 text-sm font-medium text-gray-500">Профиль</span>
            </div>
            <div class="w-8 h-0.5 bg-gray-300"></div>
            <div class="flex items-center">
                <div id="step-3-indicator" class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-medium">3</div>
                <span class="ml-2 text-sm font-medium text-gray-500">Роль</span>
            </div>
        </div>

        <!-- Error Alert -->
        <div id="error-alert" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex items-center">
                <i class="ri-error-warning-line text-red-600 mr-2"></i>
                <span id="error-message" class="text-red-600 text-sm"></span>
            </div>
        </div>

        <!-- Step 1: Account Details -->
        <form id="step-1-form" class="space-y-6">
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
                    Email
                </label>
                <div class="relative">
                    <i class="ri-mail-line absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input
                        id="email"
                        name="email"
                        type="email"
                        required
                        autocomplete="email"
                        class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none"
                        placeholder="your@email.com"
                    >
                </div>
            </div>

            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">
                    Пароль
                </label>
                <div class="relative">
                    <i class="ri-lock-line absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input
                        id="password"
                        name="password"
                        type="password"
                        required
                        minlength="6"
                        autocomplete="new-password"
                        class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none"
                        placeholder="Минимум 6 символов"
                    >
                    <button
                        type="button"
                        id="toggle-password"
                        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                    >
                        <i class="ri-eye-line" id="password-icon"></i>
                    </button>
                </div>
            </div>

            <div>
                <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">
                    Подтвердите пароль
                </label>
                <div class="relative">
                    <i class="ri-lock-line absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input
                        id="confirm-password"
                        name="confirm-password"
                        type="password"
                        required
                        autocomplete="new-password"
                        class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none"
                        placeholder="Повторите пароль"
                    >
                </div>
            </div>

            <button
                type="submit"
                id="next-step-1"
                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50 disabled:cursor-not-allowed button-ripple"
            >
                <span id="step-1-button-text">Продолжить</span>
                <i id="step-1-loading-icon" class="ri-loader-4-line animate-spin ml-2 hidden"></i>
            </button>
        </form>

        <!-- Step 2: Profile Details -->
        <form id="step-2-form" class="space-y-6 hidden">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">
                        Имя
                    </label>
                    <input
                        id="firstName"
                        name="firstName"
                        type="text"
                        required
                        autocomplete="given-name"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none"
                        placeholder="Ваше имя"
                    >
                </div>
                <div>
                    <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">
                        Фамилия
                    </label>
                    <input
                        id="lastName"
                        name="lastName"
                        type="text"
                        required
                        autocomplete="family-name"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none"
                        placeholder="Ваша фамилия"
                    >
                </div>
            </div>

            <div>
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">
                    Телефон (необязательно)
                </label>
                <div class="relative">
                    <i class="ri-phone-line absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input
                        id="phone"
                        name="phone"
                        type="tel"
                        autocomplete="tel"
                        class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none"
                        placeholder="+420 XXX XXX XXX"
                    >
                </div>
            </div>

            <div class="flex space-x-4">
                <button
                    type="button"
                    id="prev-step-2"
                    class="flex-1 py-2 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary button-ripple"
                >
                    Назад
                </button>
                <button
                    type="submit"
                    id="next-step-2"
                    class="flex-1 py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50 disabled:cursor-not-allowed button-ripple"
                >
                    <span id="step-2-button-text">Продолжить</span>
                    <i id="step-2-loading-icon" class="ri-loader-4-line animate-spin ml-2 hidden"></i>
                </button>
            </div>
        </form>

        <!-- Step 3: Role Selection -->
        <div id="step-3-form" class="space-y-6 hidden">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-4">
                    Выберите вашу роль
                </label>
                <div class="space-y-3">
                    <label class="flex items-center p-4 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="role" value="candidate" class="h-4 w-4 text-primary focus:ring-primary border-gray-300" checked>
                        <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900">Соискатель</div>
                            <div class="text-sm text-gray-500">Ищу работу в Чехии</div>
                        </div>
                    </label>
                    <label class="flex items-center p-4 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="role" value="employer" class="h-4 w-4 text-primary focus:ring-primary border-gray-300">
                        <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900">Работодатель</div>
                            <div class="text-sm text-gray-500">Ищу сотрудников</div>
                        </div>
                    </label>
                    <label class="flex items-center p-4 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="role" value="agency" class="h-4 w-4 text-primary focus:ring-primary border-gray-300">
                        <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900">Агентство</div>
                            <div class="text-sm text-gray-500">Кадровое агентство</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Conditional fields for employer/agency -->
            <div id="employer-fields" class="space-y-4 hidden">
                <div>
                    <label for="company" class="block text-sm font-medium text-gray-700 mb-1">
                        Название компании
                    </label>
                    <input
                        id="company"
                        name="company"
                        type="text"
                        autocomplete="organization"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none"
                        placeholder="Название вашей компании"
                    >
                </div>
                <div>
                    <label for="position" class="block text-sm font-medium text-gray-700 mb-1">
                        Ваша должность
                    </label>
                    <input
                        id="position"
                        name="position"
                        type="text"
                        autocomplete="organization-title"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none"
                        placeholder="HR менеджер, директор и т.д."
                    >
                </div>
            </div>

            <div class="flex space-x-4">
                <button
                    type="button"
                    id="prev-step-3"
                    class="flex-1 py-2 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary button-ripple"
                >
                    Назад
                </button>
                <button
                    type="button"
                    id="complete-signup"
                    class="flex-1 py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50 disabled:cursor-not-allowed button-ripple"
                >
                    <span id="step-3-button-text">Завершить регистрацию</span>
                    <i id="step-3-loading-icon" class="ri-loader-4-line animate-spin ml-2 hidden"></i>
                </button>
            </div>
        </div>

        <!-- Divider -->
        <div class="relative">
            <div class="absolute inset-0 flex items-center">
                <div class="w-full border-t border-gray-300"></div>
            </div>
            <div class="relative flex justify-center text-sm">
                <span class="px-2 bg-gray-50 text-gray-500">или</span>
            </div>
        </div>

        <!-- Google Sign Up -->
        <button
            id="google-signup"
            type="button"
            class="w-full flex justify-center items-center py-2 px-4 border border-gray-300 rounded-lg shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50 disabled:cursor-not-allowed button-ripple"
        >
            <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
                <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            <span id="google-button-text">Зарегистрироваться через Google</span>
            <i id="google-loading-icon" class="ri-loader-4-line animate-spin ml-2 hidden"></i>
        </button>

        <!-- Sign In Link -->
        <div class="text-center">
            <p class="text-sm text-gray-600">
                Уже есть аккаунт? 
                <a href="/auth/signin.html" class="font-medium text-primary hover:text-primary/80">
                    Войти
                </a>
            </p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Import Firebase configuration
        import { firebaseConfig } from '../firebase-config.js';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // Form data storage
        let formData = {
            email: '',
            password: '',
            firstName: '',
            lastName: '',
            phone: '',
            role: 'candidate',
            company: '',
            position: ''
        };

        let currentStep = 1;

        // DOM elements
        const step1Form = document.getElementById('step-1-form');
        const step2Form = document.getElementById('step-2-form');
        const step3Form = document.getElementById('step-3-form');
        const errorAlert = document.getElementById('error-alert');
        const errorMessage = document.getElementById('error-message');
        const togglePasswordButton = document.getElementById('toggle-password');
        const passwordInput = document.getElementById('password');
        const passwordIcon = document.getElementById('password-icon');
        const employerFields = document.getElementById('employer-fields');

        // Step indicators
        const step1Indicator = document.getElementById('step-1-indicator');
        const step2Indicator = document.getElementById('step-2-indicator');
        const step3Indicator = document.getElementById('step-3-indicator');

        // Buttons
        const nextStep1Button = document.getElementById('next-step-1');
        const prevStep2Button = document.getElementById('prev-step-2');
        const nextStep2Button = document.getElementById('next-step-2');
        const prevStep3Button = document.getElementById('prev-step-3');
        const completeSignupButton = document.getElementById('complete-signup');
        const googleSignupButton = document.getElementById('google-signup');

        // Toggle password visibility
        togglePasswordButton.addEventListener('click', () => {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            passwordIcon.className = type === 'password' ? 'ri-eye-line' : 'ri-eye-off-line';
        });

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorAlert.classList.remove('hidden');
        }

        // Hide error message
        function hideError() {
            errorAlert.classList.add('hidden');
        }

        // Update step indicators
        function updateStepIndicators(step) {
            step1Indicator.className = `w-8 h-8 rounded-full ${step >= 1 ? 'bg-primary text-white' : 'bg-gray-300 text-gray-600'} flex items-center justify-center text-sm font-medium`;
            step2Indicator.className = `w-8 h-8 rounded-full ${step >= 2 ? 'bg-primary text-white' : 'bg-gray-300 text-gray-600'} flex items-center justify-center text-sm font-medium`;
            step3Indicator.className = `w-8 h-8 rounded-full ${step >= 3 ? 'bg-primary text-white' : 'bg-gray-300 text-gray-600'} flex items-center justify-center text-sm font-medium`;
        }

        // Show step
        function showStep(step) {
            step1Form.classList.toggle('hidden', step !== 1);
            step2Form.classList.toggle('hidden', step !== 2);
            step3Form.classList.toggle('hidden', step !== 3);
            updateStepIndicators(step);
        }

        // Handle role selection
        document.querySelectorAll('input[name="role"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                formData.role = e.target.value;
                employerFields.classList.toggle('hidden', e.target.value === 'candidate');
            });
        });

        // Step 1: Account details
        step1Form.addEventListener('submit', (e) => {
            e.preventDefault();
            hideError();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (password !== confirmPassword) {
                showError('Пароли не совпадают');
                return;
            }

            if (password.length < 6) {
                showError('Пароль должен содержать минимум 6 символов');
                return;
            }

            formData.email = email;
            formData.password = password;

            currentStep = 2;
            showStep(currentStep);
        });

        // Step 2: Profile details
        step2Form.addEventListener('submit', (e) => {
            e.preventDefault();
            hideError();

            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const phone = document.getElementById('phone').value;

            if (!firstName || !lastName) {
                showError('Пожалуйста, заполните имя и фамилию');
                return;
            }

            formData.firstName = firstName;
            formData.lastName = lastName;
            formData.phone = phone;

            currentStep = 3;
            showStep(currentStep);
        });

        // Navigation buttons
        prevStep2Button.addEventListener('click', () => {
            currentStep = 1;
            showStep(currentStep);
        });

        prevStep3Button.addEventListener('click', () => {
            currentStep = 2;
            showStep(currentStep);
        });

        // Complete signup
        completeSignupButton.addEventListener('click', async () => {
            hideError();

            const company = document.getElementById('company').value;
            const position = document.getElementById('position').value;

            formData.company = company;
            formData.position = position;

            // Set loading state
            completeSignupButton.disabled = true;
            document.getElementById('step-3-button-text').style.display = 'none';
            document.getElementById('step-3-loading-icon').classList.remove('hidden');

            try {
                // Create user with email and password
                const userCredential = await createUserWithEmailAndPassword(auth, formData.email, formData.password);
                const user = userCredential.user;

                // Update profile
                await updateProfile(user, {
                    displayName: `${formData.firstName} ${formData.lastName}`
                });

                // Save user profile to Firestore
                await setDoc(doc(db, 'users', user.uid), {
                    uid: user.uid,
                    email: user.email,
                    displayName: `${formData.firstName} ${formData.lastName}`,
                    firstName: formData.firstName,
                    lastName: formData.lastName,
                    phoneNumber: formData.phone || null,
                    role: formData.role,
                    company: formData.company || null,
                    position: formData.position || null,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    isEmailVerified: user.emailVerified
                });

                console.log('Successfully registered:', user);
                
                // Redirect to dashboard
                window.location.href = '/dashboard.html';
            } catch (error) {
                console.error('Registration error:', error);
                
                let errorMsg = 'Ошибка регистрации. Попробуйте снова.';
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMsg = 'Пользователь с таким email уже существует';
                        break;
                    case 'auth/invalid-email':
                        errorMsg = 'Неверный формат email';
                        break;
                    case 'auth/weak-password':
                        errorMsg = 'Пароль слишком слабый';
                        break;
                }
                
                showError(errorMsg);
            } finally {
                completeSignupButton.disabled = false;
                document.getElementById('step-3-button-text').style.display = 'inline';
                document.getElementById('step-3-loading-icon').classList.add('hidden');
            }
        });

        // Google signup
        googleSignupButton.addEventListener('click', async () => {
            hideError();

            // Set loading state
            googleSignupButton.disabled = true;
            document.getElementById('google-button-text').style.display = 'none';
            document.getElementById('google-loading-icon').classList.remove('hidden');

            try {
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;

                // Check if user is new
                if (result._tokenResponse?.isNewUser) {
                    // Save user profile to Firestore with default role
                    await setDoc(doc(db, 'users', user.uid), {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        role: 'candidate', // Default role
                        createdAt: new Date(),
                        updatedAt: new Date(),
                        isEmailVerified: user.emailVerified
                    });
                }

                console.log('Successfully signed up with Google:', user);
                
                // Redirect to dashboard
                window.location.href = '/dashboard.html';
            } catch (error) {
                console.error('Google signup error:', error);
                
                let errorMsg = 'Ошибка регистрации через Google. Попробуйте снова.';
                switch (error.code) {
                    case 'auth/popup-closed-by-user':
                        errorMsg = 'Окно входа было закрыто';
                        break;
                    case 'auth/popup-blocked':
                        errorMsg = 'Всплывающее окно было заблокировано браузером';
                        break;
                    case 'auth/cancelled-popup-request':
                        errorMsg = 'Запрос на вход был отменен';
                        break;
                }
                
                showError(errorMsg);
            } finally {
                googleSignupButton.disabled = false;
                document.getElementById('google-button-text').style.display = 'inline';
                document.getElementById('google-loading-icon').classList.add('hidden');
            }
        });
    </script>
</body>
</html> 