name: üîê Secure Firebase Deploy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  security-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: üîç Check for exposed secrets
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —É—Ç–µ—á–∫—É —Å–µ–∫—Ä–µ—Ç–æ–≤..."
          if grep -r "AIzaSyAo34JvPwyqjwzjhd-d-qEKh7HqAAWsIiM" public/; then
            echo "‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω —Å—Ç–∞—Ä—ã–π API –∫–ª—é—á!"
            exit 1
          fi
          echo "‚úÖ –°–µ–∫—Ä–µ—Ç—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã"

  deploy:
    needs: security-check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: üì¶ Install dependencies
        run: npm install
        
      - name: üîê Replace API key with environment variable
        run: |
          echo "üîê –ó–∞–º–µ–Ω—è–µ–º API –∫–ª—é—á –Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
          sed -i 's/AIzaSyBQBIE0lphKrKyq40dGmv3zDACVnJL90Z0/\${{ secrets.FIREBASE_API_KEY }}/g' public/js/firebase-config.js
          echo "‚úÖ API –∫–ª—é—á –∑–∞–º–µ–Ω–µ–Ω"
          
      - name: üî• Deploy to Firebase
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          projectId: workincz-759c7
          channelId: live
          
      - name: ‚úÖ Deploy success
        run: |
          echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
          echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: https://workincz-759c7.web.app" 